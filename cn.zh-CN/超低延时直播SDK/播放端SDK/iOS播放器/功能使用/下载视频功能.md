# 下载视频功能 {#concept_1253735 .concept}

本文介绍了下载视频功能。

阿里云SDK提供了点播服务视频的下载功能，能够通过VidSts和VidAuth下载点播服务上的视频。同时，下载的方式提供了安全下载和普通下载的模式（在控制台设置）。

-   普通下载含义是：即使点播服务已经加密过了，下载后的视频数据也不是经过阿里云加密的。也就是说，用户可以用第三方播放器播放。
-   安全下载含义是：即使点播服务没有加密视频，下载后的视频数据也是经过阿里云加密的。也就是说，用户用第三方播放器是播放不了的。只能使用阿里云的播放器去播放

视频下载的基本流程如下：

创建并设置下载器-\>设置事件监听-\>准备下载源-\>准备成功后选择下载项-\>更新下载源并开始下载-\>下载成功/失败后，释放下载器。

## 1.创建并设置下载器 {#section_e2j_804_4w6 .section}

创建下载器。代码如下：

``` {#codeblock_qb6_evh_6tk}
AliMediaDownloader *downloader = [[AliMediaDownloader alloc] init];
[downloader setSaveDirectory:self.downLoadPath];
[downloader setDelegate:self];
```

下载SDK支持私有加密的下载。为了保证安全性，需要配置一个加密校验文件到播放器。（建议在Application中配置一次即可）

``` {#codeblock_kak_bva_rwb}
NSString *encrptyFilePath = [[NSBundle mainBundle] pathForResource:@"encryptedApp" ofType:@"dat"];
[AliPrivateService initKey:encrptyFilePath];
```

下载时如果是安全下载，那么不一致的话，会导致下载失败。

## 2.设置监听事件 {#section_qw5_iws_mpk .section}

下载器提供了多个事件监听。设置代码如下：

``` {#codeblock_jw2_sg9_fk6}
-(void)onPrepared:(AliMediaDownloader *)downloader mediaInfo:(AVPMediaInfo *)info {
    //准备下载项成功
}

-(void)onError:(AliMediaDownloader *)downloader errorModel:(AVPErrorModel *)errorModel {
    //下载出错
}

-(void)onDownloadingProgress:(AliMediaDownloader *)downloader percentage:(int)percent {
    //下载进度百分比
}

-(void)onProcessingProgress:(AliMediaDownloader *)downloader percentage:(int)percent {
    //处理进度百分比
}

-(void)onCompletion:(AliMediaDownloader *)downloader {
    //下载成功
}
```

## 3.准备下载源 {#section_n6h_3sa_mk4 .section}

通过preapre方法准备下载源。下载源支持AVPVidStsSource和AVPVidAuthSource两种。

以AVPVidStsSource举例：

``` {#codeblock_6uf_u8o_huy}
//创建VidSts
AVPVidStsSource* stsSource = [[AVPVidStsSource alloc] init];
stsSource.vid = source.vid;//视频vid
stsSource.region = DEFAULT_SERVER.region;//接入区域
stsSource.securityToken = DEFAULT_SERVER.securityToken;//安全token
stsSource.accessKeySecret = DEFAULT_SERVER.accessKeySecret;//临时akSecret
stsSource.accessKeyId = DEFAULT_SERVER.accessKeyId;//临时akId
//准备下载源
[downloader prepareWithVid:stsSource];
```

## 4.准备成功后选择下载项 {#section_8va_o15_8oc .section}

准备成功后，会回调onPrepared方法。

选择某个Track进行下载：

``` {#codeblock_579_ym3_54f}
-(void)onPrepared:(AliMediaDownloader *)downloader mediaInfo:(AVPMediaInfo *)info {
    NSArray<AVPTrackInfo*>* tracks = info.tracks;
    //比如：下载第一个TrackInfo
    [downloader selectTrack:[tracks objectAtIndex:0].trackIndex];
}
```

## 5.更新下载源并开始下载 {#section_hlh_rxm_z3b .section}

经过第4步之后，就可以开始下载了\(为了防止VidSts和VidAuth过期，最好更新一下下载源的信息\)：

``` {#codeblock_j59_aee_6yo}
//更新下载源
[downloader updateWithVid:vidSource]
//开始下载
[downloader start];
```

## 6.下载成功/失败后，释放下载器 {#section_jjy_vo3_ujw .section}

下载成功后，调用destroy释放下载器。

``` {#codeblock_9vz_kcp_hbn}
[self.downloader destroy];
self.downloader = nil;
```

